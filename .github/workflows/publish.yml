name: Publish Docker image

on:
  push:
    branches: [ "main" ]
    tags: [ "*" ]

permissions:
  contents: read
  packages: write

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Normalize owner to lowercase
        id: owner
        run: echo "name=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Detect tag
        id: tag
        run: |
          TAG=$(git describe --tags --exact-match 2>/dev/null || true)
          if [ -z "$TAG" ]; then
            echo "tag=latest" >> $GITHUB_OUTPUT
          else
            echo "tag=$TAG" >> $GITHUB_OUTPUT
          fi

      - name: Login to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build Docker image
        run: |
          OWNER=${{ steps.owner.outputs.name }}
          IMAGE_BASE=ghcr.io/$OWNER/myapp
          TAG=${{ steps.tag.outputs.tag }}

          echo "Building image: $IMAGE_BASE:$TAG"
          docker build -t $IMAGE_BASE:$TAG .

          if [ "$TAG" != "latest" ]; then
            docker tag $IMAGE_BASE:$TAG $IMAGE_BASE:latest
          fi

      - name: Push Docker image
        run: |
          OWNER=${{ steps.owner.outputs.name }}
          IMAGE_BASE=ghcr.io/$OWNER/myapp
          TAG=${{ steps.tag.outputs.tag }}

          docker push $IMAGE_BASE:$TAG

          if [ "$TAG" != "latest" ]; then
            docker push $IMAGE_BASE:latest
          fi
