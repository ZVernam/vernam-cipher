name: Publish Docker image

on:
  push:
    branches:
      - main
    tags:
      - '*'  # triggers on any git tag push

permissions:
  contents: read
  packages: write

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # required to read git tags

      - name: Detect tag
        id: tag
        run: |
          TAG=$(git describe --tags --exact-match 2>/dev/null || true)
          if [ -z "$TAG" ]; then
            echo "tag=latest" >> $GITHUB_OUTPUT
          else
            echo "tag=$TAG" >> $GITHUB_OUTPUT
          fi

      - name: Login to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build Docker image
        run: |
          IMAGE_BASE=ghcr.io/${{ github.repository_owner }}/myapp
          TAG=${{ steps.tag.outputs.tag }}

          echo "Building image: $IMAGE_BASE:$TAG"
          docker build -t $IMAGE_BASE:$TAG .

          # If tag is not "latest", also tag "latest"
          if [ "$TAG" != "latest" ]; then
            docker tag $IMAGE_BASE:$TAG $IMAGE_BASE:latest
          fi

      - name: Push Docker image
        run: |
          IMAGE_BASE=ghcr.io/${{ github.repository_owner }}/myapp
          TAG=${{ steps.tag.outputs.tag }}

          # Push tag
          docker push $IMAGE_BASE:$TAG

          # Also push latest if needed
          if [ "$TAG" != "latest" ]; then
            docker push $IMAGE_BASE:latest
          fi
